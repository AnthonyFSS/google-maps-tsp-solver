 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml"> 
<head> 
<meta http-equiv="content-type" content="text/html; charset=utf-8"/> 
<title>Google Maps TSP Solver Test Interface</title> 
<style type="text/css"> 
    v\:* {
      behavior:url(#default#VML);
    }
    </style> 
<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAvygGeDLnH_oMEXYhZUG2jBSRvfnVL9Z7D89GKRL1uQiEuOhTJxTYb5idNXuzfbvu5EJcVlEbesMtmQ"
type="text/javascript"></script> 
<script type="text/javascript" src="BpTspSolver.js"></script> 
<script type="text/javascript">
var tsp; // The BpTspSolver object which handles the TSP computation.
var isDone = false;
var reasons = new Array();
reasons[G_GEO_SUCCESS]            = "Success";
reasons[G_GEO_MISSING_ADDRESS]    = "Missing Address: The address was either missing or had no value.";
reasons[G_GEO_UNKNOWN_ADDRESS]    = "Unknown Address:  No corresponding geographic location could be found for the specified address.";
reasons[G_GEO_UNAVAILABLE_ADDRESS]= "Unavailable Address:  The geocode for the given address cannot be returned due to legal or contractual reasons.";
reasons[G_GEO_BAD_KEY]            = "Bad Key: The API key is either invalid or does not match the domain for which it was given";
reasons[G_GEO_TOO_MANY_QUERIES]   = "Too Many Queries: The daily geocoding quota for this site has been exceeded.";
reasons[G_GEO_SERVER_ERROR]       = "Server error: The geocoding request could not be successfully processed.";

/* Returns a textual representation of time in the format 
 * "N days M hrs P min Q sec". Does not include days if
 * 0 days etc. Does not include seconds if time is more than
 * 1 hour.
 */
function formatTime(seconds) {
  var days;
  var hours;
  var minutes;
  days = parseInt(seconds / (24*3600));
  seconds -= days * 24 * 3600;
  hours = parseInt(seconds / 3600);
  seconds -= hours * 3600;
  minutes = parseInt(seconds / 60);
  seconds -= minutes * 60;
  var ret = "";
  if (days > 0) 
    ret += days + " days ";
  if (days > 0 || hours > 0) 
    ret += hours + " hrs ";
  if (days > 0 || hours > 0 || minutes > 0) 
    ret += minutes + " min ";
  if (days == 0 && hours == 0)
    ret += seconds + " sec";
  return(ret);
}

/* Returns textual representation of distance in the format
 * "N km M m". Does not include km if less than 1 km. Does not
 * include meters if km >= 10.
 */
function formatLength(meters) {
  var km = parseInt(meters / 1000);
  meters -= km * 1000;
  var ret = "";
  if (km > 0) 
    ret += km + " km ";
  if (km < 10)
    ret += meters + " m";
  return(ret);
}

function drawMarker(latlng, num) {
  var icon;
  var letter = num == 1 ? 'r' : 'b';
  icon = new GIcon(G_DEFAULT_ICON, "icons/icon" + letter + num + ".png");
  icon.printImage = "icons/icon" + letter + num + ".png";
  icon.mozPrintImage = "icons/icon" + letter + num + ".gif";
  gebMap.addOverlay(new GMarker(latlng, {icon: icon }));
}

function setViewportToCover(waypoints) {
  var bounds = new GLatLngBounds();
  for (var i = 0; i < waypoints.length; ++i) {
    bounds.extend(waypoints[i]);
  }
  gebMap.setCenter(bounds.getCenter());
  gebMap.setZoom(gebMap.getBoundsZoomLevel(bounds));
}

function loadAtStart(lat, lng, zoom) {
  if (GBrowserIsCompatible()) {
    gebMap = new GMap2(document.getElementById("map"));
    directionsPanel = document.getElementById("my_textual_div");
  
    gebMap.setCenter(new GLatLng(lat, lng), zoom);
    gebMap.addControl(new GLargeMapControl());
    gebMap.addControl(new GMapTypeControl());

    tsp = new BpTspSolver(gebMap, directionsPanel);
    gebDirections = tsp.getGDirections();
    GEvent.addListener(gebDirections, "error", function() {
      alert("Request failed: " + reasons[gebDirections.getStatus().code]);
    });

    GEvent.addListener(gebMap, "click", function(marker, latLng) {
      if (marker == null) {
	tsp.addWaypoint(latLng);
	drawMarker(latLng, tsp.getWaypoints().length);
      } else {
        tsp.removeWaypoint(marker.getPoint());
        gebMap.removeOverlay(marker);
      }
    });
  }
  else {
    alert('Your browser is not compatible with this technology.\nPlease consider upgrading.');
  }
}

function addWaypoint(latLng) {
  tsp.addWaypoint(latLng);
}

function addAddress(addr) {
  tsp.addAddress(addr, addAddressSuccessCallback);
}

function clickedAddAddress() {
  tsp.addAddress(document.address.addressStr.value, addAddressSuccessCallback2);
}

function addAddressSuccessCallback(address, latlng) {
  if (latlng)
    drawMarker(latlng, tsp.getWaypoints().length);
  else
    alert('Failed to geocode: ' + address);
}

function addAddressSuccessCallback2(address, latlng) {
  if (latlng) {
    drawMarker(latlng, tsp.getWaypoints().length);
    setViewportToCover(tsp.getWaypoints());
  }
  else
    alert('Failed to geocode: ' + address);
}

function startOver() {
  document.getElementById("my_textual_div").innerHTML = "";
  document.getElementById("path").innerHTML = "";
  gebMap.clearOverlays();
  tsp.startOver(); // doesn't clearOverlays or clear the directionsPanel
}

function directions(m, walking, avoid) {
  gebMap.clearOverlays();
  tsp.setAvoidHighways(avoid);
  if (walking)
    tsp.setTravelMode(G_TRAVEL_MODE_WALKING);
  else
    tsp.setTravelMode(G_TRAVEL_MODE_DRIVING);
  gebMap.clearOverlays();
  if (m == 0)
    tsp.solveRoundTrip(onSolveCallback);
  else
    tsp.solveAtoZ(onSolveCallback);
}

function onSolveCallback(myTsp) {
  var dir = tsp.getGDirections();
  // Print shortest roundtrip data:
  var pathStr = "<p>Trip duration: " + formatTime(dir.getDuration().seconds) + "<br>";
  pathStr += "Trip length: " + formatLength(dir.getDistance().meters) + "</p>";
 document.getElementById("path").innerHTML = pathStr;

  var bestPathLatLngStr = "";
  for (var i = 0; i < gebDirections.getNumGeocodes(); ++i) {
    bestPathLatLngStr += "(" + gebDirections.getGeocode(i).Point.coordinates[1]
      + ", " + gebDirections.getGeocode(i).Point.coordinates[0] + ")\n";
  }
  document.getElementById("exportData").innerHTML = 
    "<textarea name='outputList' rows='10' cols='40'>" 
    + bestPathLatLngStr + "</textarea><br>";

  var durationsMatrixStr = "";
  var dur = tsp.getDurations();
  for (var i = 0; i < dur.length; ++i) {
    for (var j = 0; j < dur[i].length; ++j) {
      durationsMatrixStr += dur[i][j];
      if (j == dur[i].length - 1) {
        durationsMatrixStr += "\n";
      } else {
        durationsMatrixStr += ", ";
      }
    }
  }
  document.getElementById("durationsData").innerHTML = 
    "<textarea name='csvDurationsMatrix' rows='10' cols='40'>" 
    + durationsMatrixStr + "</textarea><br>";

  orderStr = "";
  for (var i = 0; i < tsp.getOrder().length; ++i) {
    orderStr += tsp.getOrder()[i] + " ";
  }
  document.getElementById("ordering").innerHTML = orderStr;

  isDone = true;
}

function isDone() {
  return isDone;
}

function init() {
  isDone = false;
  loadAtStart(37.4419, -122.1419, 8);
}
</script>  
</head> 
<body onload='init()' onunload='GUnload()'> 
<div id="map"
     style="width: 640px; height: 480px;">
</div><br><br> 
<div><form name="address" onSubmit="clickedAddAddress(); return false;"> 
    Add Location by Address: <input name="addressStr" type="text"> 
    <input type="button" value="Add!" onClick="clickedAddAddress()"> 
    </form>
</div>  
<form name="travelOpts"> 
<table> 
  <tr> 
  <td><input id="walking" type="checkbox">Walking</input><br></td> 
  <td><input id="avoidHighways" type="checkbox">Avoid highways</input><br></td> 
  </tr> 
</table> 
</form> 
<table class="buttonTable"> 
  <tr> 
  <td><input id="button1" type="button" value="Calculate Fastest
  Roundtrip" onClick="directions(0, document.forms['travelOpts'].walking.checked, document.forms['travelOpts'].avoidHighways.checked)"></td> 
  <td><input id="button2" type="button" value="Calculate Fastest A-Z Trip" onClick="directions(1, document.forms['travelOpts'].walking.checked, document.forms['travelOpts'].avoidHighways.checked)"></td> 
  <td><input id='button3' class="calcButton" type='button' value='Start Over Again' onClick='startOver()'></td> 
  </tr> 
</table> 
<div id="path"></div> 
<div id="exportData"></div> 
<div id="durationsData"></div>
<div id="ordering"></div>
<div id="my_textual_div"></div><br> 
</body> 
</html>
